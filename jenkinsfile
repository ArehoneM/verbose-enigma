pipeline {
    agent any

    environment {
        REGISTRY = "localhost:5000"
        APP_NAME = "my-app"
        VERSION = "v1.0"
    }

    stages {

        stage('Build Image') {
            steps {
                sh """
                    podman build -t ${REGISTRY}/${APP_NAME}:${VERSION} .
                """
            }
        }

        stage('Push Image & Tag for Environments') {
            steps {
                sh """
                    # Push base image
                    podman push --tls-verify=false ${REGISTRY}/${APP_NAME}:${VERSION}

                    # Tag and push for environments
                    for env in uat stg prod; do
                        podman tag ${REGISTRY}/${APP_NAME}:${VERSION} ${REGISTRY}/${APP_NAME}:${VERSION}-\$env
                        podman push --tls-verify=false ${REGISTRY}/${APP_NAME}:${VERSION}-\$env
                    done
                """
            }
        }

        stage('Deploy to Minikube') {
            steps {
                sh """
                    kubectl apply -f k8s/deployment-uat.yaml
                    kubectl apply -f k8s/deployment-stg.yaml
                    kubectl apply -f k8s/deployment-prod.yaml
                """
            }
        }
    }
}
